# Introduction

I have a few machines I want to access using SSH. I use public keys when connecting from a trusted computer. However, I also want to access the machines from other computers using passwords. To eliminate the consequences of brute force password cracking or even stolen passwords, I been looking for a two-factor authentication scheme to use if anything but public keys are used. The method described here lets me log in using publickeys without any further hassle, while I must enter a second, one time password delivered to my mobile phone by email if I use a password.

zuul is a simple script to increase security for authentication in OpenSSH servers. It lets a user who authenticates using publickey log in as usual. However, if another authentication method is used, a two factor authentication scheme is used. If, for example, the user authenticates using a password, (s)he is requested to enter a second, one time password (OTP) generated by zuul. The user receives this OTP in a way configured in `/etc/zuul.conf`. By default, the OTP is printed on the screen using ASCII captcha (if `figlet` is available), `cowsay` (if available) or in plain text. While this constitutes a basic test that the user is human, it is obviously not a great improvement in security. The delivery method of the OTP should therefore be changed, for example to e-mail or SMS.

# How it works

When a user has authenticated, the SSH server hands over the session to `zuul` using the `ForceCommand` setting (see [sshd_config(5)](http://linux.die.net/man/5/sshd_config)). `zuul` checks what authentication method was used for the current SSH session. If any other method than `publickey` was used, it generates an OTP, sends it to the user and waits for the user to enter it. If and only if the user enters the correct code, (s)he is granted access.

To determine what authentication method was used, zuul investigates `/var/log/auth.log`. Unfortunately, `zuul` runs as `$USER`, so `$USER` must be able to read this file. The least bad way I've found to allow this, is to give `$USER` password-less sudo rights to `/bin/cat /var/log/auth.log`. This effectively means that users can read this log file, despite it not being readable in the file system. If this is unacceptable to you, zuul is not what you're looking for. If you know of a better way to determine what authentication method was used, please let me know at <halhen@k2h.se>.

# FAQ

## Aren't these things better handled by a PAM module?

You could get the same results with a PAM module. However, then I would have moved away from a-quick-bash-script-on-a-weekend-afternoon-for-the-heck-of-it.

## Giving everyone read access to `/var/log/auth.log`?! Really?

All machines where I use zuul are either personal or shared with trusted people whom have sudo rights anyways. I'd say using this is a net gain in security from using password-only authentication. zuul is obviously not an enterprise thing.

## Why e-mail?

It lets me receive the OTP from anywhere, as long as I can read my email. I'm not locked out if I forgot my phone at home. E-mail is my choice. You can configure your own.

## Any alternatives?

* [Google Authenticator](http://code.google.com/p/google-authenticator/) is a PAM module which, together with a mobile phone app, gives for example Time-based One Time Passwords.

# Dependencies

* OpenSSH
* sudo

# Installation

*WARNING: YOU MAY LOCK YOURSELF OUT FROM SSH ACCESS IF SOMETHING GOES WRONG. MAKE SURE YOU HAVE A TESTED PLAN B TO ACCESS THE MACHINE YOU'RE INSTALLING ON, IN CASE YOU ARE LOCKED OUT.*

As root, perform the following steps:

Put `zuul` in the file system and make it executable for all users that should be able to log in using SSH:

    $ cp zuul /usr/local/bin
    $ chmox a+x /usr/local/bin/zuul

Copy `zuul.conf` to `/etc/zuul.conf`

    $ cp zuul.conf /etc
    $ chmod 644 /etc/zuul.conf

Now, edit /etc/zuul.conf to configure it as you please.

Next, allow users to read `/var/log/auth.log` by, as root, run `visudo` and add:

    ALL ALL=NOPASSWD: /bin/cat /var/log/auth.log

Enable zuul in OpenSSH by changing or adding the following line in `/etc/ssh/sshd_config`:

    ForceCommand /usr/local/bin/zuul

Finally, reload the `sshd` configuration:

    $ kill -SIGHUP <pid of listening sshd>

# Configuration

See zuul.conf for an example configuration file. The supplied zuul.conf uses email to deliver the OTP. Together with push email on a mobile phone, this gives a fast delivery method of the password. Many other ways obviously exist. See the example zuul.conf for details.

# Portability

WorksForMe(tm). Tested on OpenSSH on Archlinux (as of October 2011) and Debian Squeeze. I'd be happy to accept patches if you port it to other platforms.

# License

Released under the [Simplified BSD License](http://www.opensource.org/licenses/bsd-license.php).

# Feedback

If you have feedback or find a bug, I'd be happy to hear from you at <halhen@k2h.se>.
